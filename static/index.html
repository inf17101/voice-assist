<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Voice Assist — Demo</title>
		<!-- Using system font stack (no external Google Fonts) -->
		<style>
			:root{
				--bg:#0f1724;
				--card:#0b1220;
				--muted:#9aa4b2;
				--accent:#7c5cff;
				--accent-2:#ffd86b;
			}
			*{box-sizing:border-box}
			html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:#e6eef6;background:linear-gradient(180deg,var(--bg),#071126);}
			.wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:48px}
			.card{width:100%;max-width:820px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:28px;box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03);}
			.header{display:flex;align-items:center;gap:16px}
			h1{margin:0;font-size:1.35rem}
			p.lead{margin:6px 0 18px;color:var(--muted)}
			.controls{display:flex;align-items:center;gap:12px}
			button.primary{background:linear-gradient(90deg,var(--accent),#5b8bff);border:0;padding:10px 16px;border-radius:10px;color:white;font-weight:600;cursor:pointer}
			button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
			.status{color:var(--muted);font-size:0.95rem}
			.row{display:flex;gap:20px;margin-top:18px}
			.left{flex:1}
			.right{width:220px;display:flex;flex-direction:column;align-items:center;gap:12px}
			audio{width:100%;border-radius:8px}

			/* Bulb */
			.bulb-wrap{width:120px;height:120px;background:linear-gradient(180deg,#07112a,#081022);border-radius:18px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03)}
			.bulb{width:64px;height:64px;filter:drop-shadow(0 8px 30px rgba(124,92,255,0.18));transition:transform .18s ease}
			.bulb svg{display:block;width:100%;height:100%}
			.speaking{animation:glow 1s ease-in-out infinite}
			@keyframes glow{
				0%{transform:scale(1);filter:drop-shadow(0 6px 10px rgba(255,216,107,0.08))}
				50%{transform:scale(1.07);filter:drop-shadow(0 18px 40px rgba(124,92,255,0.26))}
				100%{transform:scale(1);filter:drop-shadow(0 6px 10px rgba(255,216,107,0.08))}
			}

			.meta{font-size:0.9rem;color:var(--muted);text-align:center}
			footer{margin-top:18px;color:var(--muted);font-size:0.85rem;text-align:center}

			@media(max-width:720px){.row{flex-direction:column}.right{width:100%}.bulb-wrap{width:100px;height:100px}}
		</style>
	</head>
	<body>
		<div class="wrap">
			<div class="card">
				<div class="header">
					<div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#5b8bff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700">VA</div>
					<div>
						<h1>Voice Assist — Demo</h1>
						<p class="lead">Start a WebRTC session to send your microphone audio and receive spoken replies from the assistant.</p>
					</div>
				</div>

				<div class="row">
					<div class="left">
						<div class="controls">
							<button id="startButton" class="primary">Start</button>
							<button id="stopButton" class="ghost">Stop</button>
							<div class="status" id="status">Idle</div>
						</div>

						<div style="margin-top:16px">
							<audio id="audio_output_component_id" controls autoplay></audio>
						</div>

						<div style="margin-top:12px;color:var(--muted);font-size:0.92rem">Open devtools to view ICE/SDP logs. Allow microphone access when prompted.</div>
					</div>

					<div class="right">
						<div class="bulb-wrap">
							<div id="bulb" class="bulb" title="Assistant speaking indicator">
								<!-- simple bulb SVG -->
								<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<defs>
										<linearGradient id="g1" x1="0" x2="1">
											<stop offset="0" stop-color="#ffd86b"/>
											<stop offset="1" stop-color="#7c5cff"/>
										</linearGradient>
									</defs>
									<path d="M9 21h6v-1a1 1 0 0 0-1-1H10a1 1 0 0 0-1 1v1z" fill="#d6dbe7"/>
									<path d="M12 2a6 6 0 0 0-4 10.9V15a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.1A6 6 0 0 0 12 2z" fill="url(#g1)"/>
									<circle cx="12" cy="10" r="1.2" fill="#fff" opacity="0.6" />
								</svg>
							</div>
						</div>
						<div class="meta">Assistant state</div>
						<div style="font-size:0.85rem;color:var(--muted);text-align:center">Bulb pulses while assistant audio plays</div>
					</div>
				</div>

				<footer>Built with fastrtc • fastapi • WebRTC</footer>
			</div>
		</div>

		<script src="/static/client.js"></script>
		<script>
			const startButton = document.getElementById('startButton');
			const stopButton = document.getElementById('stopButton');
			const status = document.getElementById('status');
			const bulb = document.getElementById('bulb');
			const audioEl = document.getElementById('audio_output_component_id');

			let connected = false;

			startButton.addEventListener('click', async () => {
				status.textContent = 'Requesting microphone...';
				try {
					await setupWebRTC(pc);
					connected = true;
					status.textContent = 'Connected';
				} catch (err) {
					console.error(err);
					status.textContent = 'Error: ' + (err.message || err);
				}
			});

			stopButton.addEventListener('click', () => {
				if (connected && pc) {
					pc.getSenders().forEach(s => { try { s.track && s.track.stop(); } catch(e){} });
					try { pc.close(); } catch(e){}
				}
				status.textContent = 'Stopped';
			});

			// Pulse the bulb while audio is playing
			function setBulbSpeaking(on){
				if(on) bulb.classList.add('speaking'); else bulb.classList.remove('speaking');
			}

			audioEl.addEventListener('play', () => setBulbSpeaking(true));
			audioEl.addEventListener('pause', () => setBulbSpeaking(false));
			audioEl.addEventListener('ended', () => setBulbSpeaking(false));

			// When a remote stream is attached to the audio element, play it and show activity
			const observer = new MutationObserver(() => {
				if(audioEl.srcObject) {
					// try to autoplay remote streams
					audioEl.play().catch(()=>{});
				}
			});
			observer.observe(audioEl, {attributes:true,childList:false,subtree:false});
		</script>
	</body>
</html>
